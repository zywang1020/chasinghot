<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Geoæ˜¯ç‚å€¼çˆ†éŒ¶</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px auto;
      max-width: 600px;
      padding: 20px;
      background: #f0f8ff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #ff6600;
    }
    label, select, input, button {
      display: block;
      width: 100%;
      margin: 15px 0;
    }
    button {
      background-color: #ff6600;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #ff8533;
    }
    #result {
      margin-top: 30px;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h1>ğŸŒ Geoæ˜¯ç‚å€¼çˆ†éŒ¶</h1>

<label for="date">é¸æ“‡æ—¥æœŸï¼š</label>
<input type="date" id="date">

<label for="surface">é¸æ“‡é‹ªé¢æè³ªï¼š</label>
<select id="surface">
  <option value="æŸæ²¹">æŸæ²¹</option>
  <option value="æ°´æ³¥">æ°´æ³¥</option>
  <option value="PU">PU</option>
  <option value="è‰åœ°">è‰åœ°</option>
</select>

<button onclick="calculateTemp()">è¨ˆç®—æº«åº¦</button>

<div id="result"></div>

<script>
const apiKey = "CWA-234F005B-7959-436C-A0FF-BD4225C0E339";

// æ¸¬ç«™åˆ—è¡¨ï¼ˆç¯„ä¾‹ï¼‰
const stations = [
  { name: "è‡ºåŒ—", lat: 25.0375, lon: 121.5637 },
  { name: "æ¿æ©‹", lat: 25.0130, lon: 121.4672 },
  { name: "æ–°ç«¹", lat: 24.8161, lon: 120.9675 },
  { name: "å˜‰ç¾©", lat: 23.4801, lon: 120.4491 },
  { name: "è‡ºå—", lat: 23.0000, lon: 120.2000 },
  { name: "é«˜é›„", lat: 22.6273, lon: 120.3014 },
  { name: "èŠ±è“®", lat: 23.9722, lon: 121.6066 },
  { name: "è‡ºæ±", lat: 22.7500, lon: 121.1500 }
];

// é‹ªé¢åç…§ç‡
const surfaceAlbedo = {
  "æŸæ²¹": 0.05,
  "æ°´æ³¥": 0.30,
  "PU": 0.10,
  "è‰åœ°": 0.25
};

// å–å¾—ç›®å‰ä½ç½®
async function getCurrentLocation() {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(
      (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
      (err) => reject(err)
    );
  });
}

// è¨ˆç®—å…©åœ°ä¹‹é–“çš„è·é›¢
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a = 
    0.5 - Math.cos(dLat)/2 + 
    Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
    (1 - Math.cos(dLon))/2;
  return R * 2 * Math.asin(Math.sqrt(a));
}

// æ‰¾æœ€è¿‘çš„æ¸¬ç«™
function findNearestStation(lat, lon) {
  let nearest = null;
  let minDist = Infinity;
  for (const s of stations) {
    const dist = getDistance(lat, lon, s.lat, s.lon);
    if (dist < minDist) {
      nearest = s;
      minDist = dist;
    }
  }
  return nearest;
}

// æŠ“æ°£è±¡è³‡æ–™
async function fetchWeather(stationName) {
  const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?Authorization=${apiKey}&format=JSON&locationName=${stationName}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    const loc = data.records.location[0];
    const temp = parseFloat(loc.weatherElement.find(e => e.elementName === "TEMP").elementValue);
    const radiation = 800; // é è¨­è¼»å°„é‡ï¼ˆçœŸå¯¦è¦æ›åˆ¥çš„APIï¼‰
    return { temp, radiation };
  } catch (err) {
    console.error(err);
    return null;
  }
}

// ä¸»è¦é‹ç®—
async function calculateTemp() {
  const surface = document.getElementById('surface').value;
  const date = document.getElementById('date').value;

  if (!surface || !date) {
    alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
    return;
  }

  try {
    const pos = await getCurrentLocation();
    const nearestStation = findNearestStation(pos.lat, pos.lon);
    console.log("æœ€è¿‘æ¸¬ç«™:", nearestStation);

    const weather = await fetchWeather(nearestStation.name);
    if (!weather) {
      document.getElementById('result').innerHTML = "âŒ ç„¡æ³•å–å¾—æ°£è±¡è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
      return;
    }

    const albedo = surfaceAlbedo[surface];
    const surfaceTemp = weather.radiation * (1 - albedo) + 5; //åŠ 5åº¦è£œæ­£é«”æ„Ÿ

    document.getElementById('result').innerHTML = `
      <h3>çµæœ</h3>
      æœ€è¿‘æ¸¬ç«™ï¼š${nearestStation.name}<br>
      ç•¶å‰æ°£æº«ï¼š${weather.temp.toFixed(1)}Â°C<br>
      é è¨­å¤ªé™½è¼»å°„é‡ï¼š${weather.radiation.toFixed(1)} W/mÂ²<br>
      é‹ªé¢æè³ªï¼š${surface}<br>
      é‹ªé¢æº«åº¦æ¨ä¼°ï¼š${surfaceTemp.toFixed(1)}Â°C
    `;
  } catch (error) {
    document.getElementById('result').innerHTML = "âŒ å®šä½å¤±æ•—æˆ–å…¶ä»–éŒ¯èª¤ï¼Œè«‹ç¢ºèªå·²é–‹å•Ÿ GPSã€‚";
  }
}
</script>

</body>
</html>
