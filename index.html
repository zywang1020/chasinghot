<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Geoæ˜¯ç‚å€¼å ±éŒ¶</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-yellow-100 via-pink-100 to-blue-100 min-h-screen flex flex-col items-center p-6">

  <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸŒ Geoæ˜¯ç‚å€¼å ±éŒ¶</h1>

  <div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-xl">
    <label class="block mb-2 font-semibold text-gray-700">é¸æ“‡æ—¥æœŸï¼š</label>
    <input id="datePicker" type="date" class="w-full mb-4 p-2 border rounded-md">

    <label class="block mb-2 font-semibold text-gray-700">é¸æ“‡é‹ªé¢é¡å‹ï¼š</label>
    <select id="surface" class="w-full mb-4 p-2 border rounded-md">
      <option value="æŸæ²¹">æŸæ²¹</option>
      <option value="æ°´æ³¥">æ°´æ³¥</option>
      <option value="PU">PU</option>
      <option value="è‰åœ°">è‰åœ°</option>
    </select>

    <button onclick="calculateTemp()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full">è¨ˆç®—æº«åº¦</button>

    <div id="result" class="mt-6"></div>
  </div>

<script>
const apiKey = "CWA-234F005B-7959-436C-A0FF-BD4225C0E339";

const surfaceMap = {
  "æŸæ²¹": { albedo: 0.05 },
  "æ°´æ³¥": { albedo: 0.30 },
  "PU": { albedo: 0.10 },
  "è‰åœ°": { albedo: 0.25 },
};

const stations = [
  { name: "è‡ºåŒ—", lat: 25.0375, lon: 121.5637, id: "466920" },
  { name: "æ¿æ©‹", lat: 25.0143, lon: 121.4672, id: "466910" },
  { name: "æ–°ç«¹", lat: 24.8138, lon: 120.9675, id: "467571" },
  { name: "å˜‰ç¾©", lat: 23.4950, lon: 120.4329, id: "467480" },
  { name: "è‡ºå—", lat: 22.9975, lon: 120.2121, id: "467410" },
  { name: "é«˜é›„", lat: 22.6273, lon: 120.3014, id: "467440" },
  { name: "èŠ±è“®", lat: 23.9722, lon: 121.6060, id: "466990" },
  { name: "è‡ºæ±", lat: 22.7519, lon: 121.1500, id: "467660" }
];

function getLocation() {
  return new Promise((resolve, reject) => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => resolve({lat: pos.coords.latitude, lon: pos.coords.longitude}),
        err => reject(err)
      );
    } else {
      reject("Geolocation not supported.");
    }
  });
}

function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function findNearestStation(userLat, userLon) {
  let minDist = Infinity;
  let nearest = null;
  stations.forEach(station => {
    const d = calcDistance(userLat, userLon, station.lat, station.lon);
    if (d < minDist) {
      minDist = d;
      nearest = station;
    }
  });
  return nearest;
}

async function getWeather(stationId, date) {
  const formattedDate = date ? `&timeFrom=${date}T00:00:00&timeTo=${date}T23:59:59` : "";
  const tempUrl = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0001-001?Authorization=${apiKey}&stationId=${stationId}${formattedDate}`;
  const radiationUrl = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization=${apiKey}&stationId=${stationId}${formattedDate}`;

  const [tempRes, radRes] = await Promise.all([
    fetch(tempUrl), fetch(radiationUrl)
  ]);
  const tempJson = await tempRes.json();
  const radJson = await radRes.json();

  const T = parseFloat(tempJson.records.location[0].weatherElement.find(e => e.elementName=="TEMP").elementValue);
  const radiationData = radJson.records.location[0].weatherElement.find(e => e.elementName=="H_wa");
  const C = parseFloat(radiationData ? radiationData.elementValue : 0);

  return { T, C };
}

async function calculateTemp() {
  try {
    const {lat, lon} = await getLocation();
    const nearestStation = findNearestStation(lat, lon);

    const surfaceType = document.getElementById("surface").value;
    const date = document.getElementById("datePicker").value;

    const { T, C } = await getWeather(nearestStation.id, date);

    const B = 0.3 * C;
    const A = T - 20;
    const cloudFactor = A / B;
    const actualRadiation = cloudFactor * C;
    const albedo = surfaceMap[surfaceType].albedo;

    const surfaceTemp = actualRadiation * (1 - albedo);
    const feelTemp = surfaceTemp + 5;

    document.getElementById("result").innerHTML = `
      <div class="bg-yellow-100 p-4 rounded-lg shadow-md">
        <p class="font-semibold">ğŸ“ æ¸¬ç«™ï¼š${nearestStation.name}</p>
        <p>ğŸŒ¡ï¸ æ°£æº«ï¼š${T} Â°C</p>
        <p>â˜€ï¸ å¤ªé™½è¼»å°„ï¼š${C.toFixed(1)} W/mÂ²</p>
        <p>ğŸŒ¥ï¸ é›²é‡ä¼°è¨ˆï¼š${cloudFactor.toFixed(2)}</p>
        <p>ğŸ”¥ ${surfaceType}è¡¨é¢æº«åº¦ï¼š${surfaceTemp.toFixed(1)} Â°C</p>
        <p>ğŸ¥µ é«”æ„Ÿæº«åº¦ï¼š${feelTemp.toFixed(1)} Â°C</p>
      </div>
    `;
  } catch (err) {
    console.error(err);
    document.getElementById("result").innerHTML = `<p class="text-red-600">âš¡ ç„¡æ³•å®šä½æˆ–å–å¾—è³‡æ–™ï¼Œè«‹å…è¨±å®šä½æˆ–ç¨å¾Œå†è©¦</p>`;
  }
}
</script>

</body>
</html>
